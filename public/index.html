<!DOCTYPE html>
<html>
  <head>
    <script src="http://localhost:3000/socket.io/socket.io.js"></script>    
  </head>
  <body>
    <header>
      <h2>Chat!</h2>
    </header>
    <main>
      <ul class="users">usuarios</ul>
      <div class="chatMessages">chat message </div>       
      <form id="chatForm">
        <label><strong>Message</strong>
          <input
            id="inputMessage"
            type="text"
            data-testid="message-box"
            placeholder="Enter Message"
          />
        </label>
        <button
          type="submit"
          id="sendBtn"
          data-testid="send-button"
        >Send</button>
      </form>
      <form id="nickForm">
        <label><strong>Nickname</strong>
          <input
            id="inputNickname"
            type="text"
            data-testid="nickname-box"
            placeholder="Chose a Nickname"
          />
        </label>
        <button
          type="submit"
          id="sendNick"
          data-testid="nickname-save"
        >Send</button>
      </form>
    </main>
  </body>
    <script>

      const socket = io('http://localhost:3000');
      const inputMessage = document.getElementById('inputMessage');
      const inputNick = document.getElementById('inputNickname');
      const usersList = document.querySelector('.users');
      const chatMessages = document.querySelector('.chatMessages');
      const sendBtn = document.getElementById('sendBtn');
      const sendNick = document.getElementById('sendNick');
      const randon = Math.round(Math.random() * 100);
      let nickname = `User${randon}`;

      // botao de enviar msg
      sendBtn.addEventListener('click', (event) => {
        event.preventDefault();
        const chatMessage = inputMessage.value;
        console.log('chatMessage', chatMessage);
        socket.emit('message', { chatMessage, nickname });

        // apaga o campo depois do envio
        inputMessage.value = '';
        // mantem o campo selecionado depois do envio
        inputMessage.focus();
      });

      // botao de salvar nick
      sendNick.addEventListener('click', (event) => {
        event.preventDefault();
        nickname = inputNick.value;
        inputNick.value= '';
      })

      // recebe as msg do banco
      socket.on('allMessage', (data) => {
        console.log('data', data);
        //map maroto pra renderizar as msg na tela
        const allMessages = data.map((msg) => {
         const message = document.createElement("p");
         message.innerText = `${msg.timestamp} - ${msg.nickname}: ${msg.chatMessage}`
         const div = document.createElement("div");
         div.appendChild(message);
         div.setAttribute('data-testid', 'message');
         chatMessages.appendChild(div);
        })
      });

      // escuta a msg
      socket.on('message', (msgData) => {
        console.log('msgData', msgData);
        const message = document.createElement("p");
         message.innerText = `${msgData}`
         const div = document.createElement("div");
         div.setAttribute('data-testid', 'message');

         div.appendChild(message);
         chatMessages.appendChild(div);

        // concrola barra de rolagem
        chatMessages.scrollTop = chatMessages.scrollHeight;
      });

      socket.on('users', (users) => {
        const allUsers = users.map((user) => {
          const guest = document.createElement('li');
          guest.innerHTML = user;
          usersList.appendChild(guest);
        })
      });

    </script>   
</html>
<!-- Cada mensagem deve ter o data-testid="message". -->