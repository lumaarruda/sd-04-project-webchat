<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebChat da Jeh</title>
    <link rel="stylesheet" type="text/css" href="style.css" />
    <script src="http://localhost:3000/socket.io/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
    <script src="http://chancejs.com/chance.min.js"></script>
  </head>
  <body>
    <header id="header">
      <h1>Bem vindo ao Bate-papo da Jeh</h1>
      <p>O seu bate papo uol com uma cara diferente!</p>
    </header>
    <div id="main">
      <div id="chat">
        <div class="chat-container">
          <p>Bem vindo <span id="title-nickname"></span></p>
        </div>
        <button type="button" id="public-chat" data-testid="public">Public Chat</button>
        <div class="chat-container" id="private-chat">
        </div>
        <form>
          <textarea type='text' id="msg-input" data-testid="message-box" rows='3'></textarea>
          <button type='button' id="send-msg" data-testid="send-button">Enviar</button>
        </form>
      </div>
      <div id="users">
        <div>
          <h4>Usuários Online</h4>
          <ul id="online-users">
          </ul>
        </div>
        <label>Nickname</label><br>
        <input type="text" data-testid="nickname-box" id="input-name"/>
        <button type="button" id="save-name" data-testid="nickname-save">Salvar</button>
      </div>
    </div>
    <script>
      const socket = io('http://localhost:3000');
      const inputNick = document.getElementById('input-name');
      const inputMsg = document.getElementById('msg-input');
      const sendButton = document.getElementById('send-msg');
      const saveNameButton = document.getElementById('save-name');
      const chatContainer = document.getElementsByClassName('chat-container')[0];
      const nickName = document.getElementById('title-nickname');
      const onlineUsersList = document.getElementById('online-users')
      const userPrivate = document.getElementsByClassName('private');
      const privateChat = document.getElementById('private-chat');
      const publicChat = document.getElementById('public-chat');

      // Trabalha com o Nick name do usuario
      nickName.innerText = chance.name(); // Nome inicial atribuido ao Usuário
      privateChat.style.display = 'none';
      socket.emit('newUser', nickName.innerText);
    
      saveNameButton.addEventListener('click', () => {
        const newNickName = inputNick.value;
        nickName.innerText = newNickName;
        socket.emit('newNickName', newNickName);
        inputNick.value = '';
      });

      // Coleta as mensagens
      sendButton.addEventListener('click', (e) => {
        e.preventDefault();
        const privPubMsg = (privateChat.style.display === 'block') ? true : false;
        if (privPubMsg) {
          console.log('emit privado')
          const chatValue = document.getElementById('private-chat').getAttribute('data-value');
          socket.emit('privateMessage', {
            anotherSocketId: chatValue,
            msg: inputMsg.value,
            nickname: nickName.textContent,
          });
        } else {
          console.log('emit publico')
          socket.emit('message', {
            nickname: nickName.textContent,
            chatMessage: inputMsg.value,
          });
          socket.on('message', (fullMsgString) => {
            return renderMessage(fullMsgString);
          });
        }
      });

      // função renderiza a mensagem
      function renderMessage(msg) {
        const p = document.createElement('p');
        p.innerText = msg;
        p.setAttribute('data-testid', 'message');
        inputMsg.value = '';
        chatContainer.appendChild(p);
      };

      // pega o historico de mensagens
      socket.on('history', (msgHistoric) => {
        msgHistoric.forEach((msg) => {
          renderMessage(msg);
        });
      });

      socket.on('privateMessage', (privateMsgSend) => {
        const p = document.createElement('p');
        p.innerText = privateMsgSend;
        p.setAttribute('data-testid', 'message');
        p.setAttribute('classname', 'privateMsg');
        inputMsg.value = '';
        privateChat.appendChild(p);
      });

      socket.on('privateMessageReceiver', (privateMsgSend) => {
        const p = document.createElement('p');
        p.innerText = privateMsgSend;
        p.setAttribute('data-testid', 'message');
        p.setAttribute('classname', 'privateMsg');
        privateChat.appendChild(p);
        inputMsg.value = '';
      });

      const ListOnlineUsers = (onlineUsers) => {
        onlineUsersList.innerHTML = '';
        // cria o primeiro elemento da lista, sempre sendo o usuario atual
        const li = document.createElement('li');
        li.setAttribute('data-testid', 'online-user');
        li.innerText = nickName.innerText;
        onlineUsersList.appendChild(li);
        // retira o usuario atual da lista
        onlineUserWithOutActual = onlineUsers.filter((user) => user.nick !== nickName.innerText);
        // imprimi a lista dos outros usuarios
        onlineUserWithOutActual.forEach((user) => {
          const li = document.createElement('li');
          li.setAttribute('data-testid', 'online-user');
          li.innerText = user.nick;
          // configora o button
          const btn = document.createElement('button');
          btn.setAttribute('data-testid', 'private');
          btn.setAttribute('onClick', `privateClick(${user})`);
          btn.type = 'button';
          btn.innerText = 'chat';
          btn.addEventListener('click', () => {
            chatContainer.style.display = "none";
            privateChat.style.display = "block";
            privateChat.setAttribute('data-value', user.id)
            socket.on('privateHistory', (allMsgPrivate) => {
              allMsgPrivate.forEach((msg) => {
                const p = document.createElement('p');
                p.innerText = privateMsgSend;
                p.setAttribute('data-testid', 'message');
                p.setAttribute('classname', 'privateMsg');
                inputMsg.value = '';
                privateChat.appendChild(p);
              });
            });
          });
          // determina o append child
          onlineUsersList.appendChild(li);
          onlineUsersList.appendChild(btn);
        });
      };

      socket.on('onlineUsers', (onlineUsers) => {
        ListOnlineUsers(onlineUsers);
      });

      socket.on('newNickName', (onlineUsers) => {
        ListOnlineUsers(onlineUsers);
      });

      socket.on('newUser', (onlineUsers) => {
        ListOnlineUsers(onlineUsers);
      });

      socket.on('disconnect', (users) => {
        console.log('MSG EMITIDA PELO BACK', users);
        onlineUsersList.innerHTML = '';
        ListOnlineUsers(onlineUsers)
        renderMessage(`usuário saiu do chat...`);
      });

      publicChat.addEventListener('click', () => {
        chatContainer.style.display = "block";
        privateChat.style.display = "none";
        const privateMsg = document.querySelectorAll('.privateMsg');
        console.log(privateMsg)
        for (p in privateMsg) {
          p.remove();
        }
      });
    </script>
  </body>
</html>
