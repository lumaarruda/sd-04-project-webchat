<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebChat da Jeh</title>
    <link rel="stylesheet" type="text/css" href="style.css" />
    <script src="http://localhost:3000/socket.io/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
    <script src="http://chancejs.com/chance.min.js"></script>
  </head>
  <body>
    <header id="header">
      <h1>Bem vindo ao Bate-papo da Jeh</h1>
      <p>O seu bate papo uol com uma cara diferente!</p>
    </header>
    <div id="main">
      <div id="chat">
        <div id="chat-container">
          <p>Bem vindo <span id="title-nickname"></span></p>
        </div>
        <form>
          <textarea type='text' id="msg-input" data-testid="message-box" rows='3'></textarea>
          <button type='button' id="send-msg" data-testid="send-button">Enviar</button>
        </form>
      </div>
      <div id="users">
        <div>
          <h4>Usuários Online</h4>
          <ul id="online-users">
          </ul>
        </div>
        <label>Nickname</label><br>
        <input type="text" data-testid="nickname-box" id="input-name"/>
        <button type="button" id="save-name" data-testid="nickname-save">Salvar</button>
      </div>
    </div>
    <script>
      const socket = io('http://localhost:3000');
      const inputNick = document.getElementById('input-name');
      const inputMsg = document.getElementById('msg-input');
      const sendButton = document.getElementById('send-msg');
      const saveNameButton = document.getElementById('save-name');
      const chatContainer = document.getElementById('chat-container');
      const nickName = document.getElementById('title-nickname');
      const onlineUsersList = document.getElementById('online-users')

      // Trabalha com o Nick name do usuario
      nickName.innerText = chance.name(); // Nome inicial atribuido ao Usuário

      socket.emit('newUser', nickName.innerText);
    
      saveNameButton.addEventListener('click', () => {
        const newNickName = inputNick.value;
        nickName.innerText = newNickName;
        socket.emit('newNickName', newNickName);
        inputNick.value = '';
      });

      // Coleta as mensagens
      sendButton.addEventListener('click', (e) => {
        e.preventDefault();
        console.log('entrou no event listener')
        socket.emit('message', {
          nickname: nickName.textContent,
          chatMessage: inputMsg.value,
        });
        socket.on('message', (fullMsgString) => {
          return renderMessage(fullMsgString);
        })
      });

      // função renderiza a mensagem
      function renderMessage(msg) {
        const p = document.createElement('p');
        p.innerText = msg;
        p.setAttribute('data-testid', 'message');
        chatContainer.appendChild(p);
        inputMsg.value = '';
      };

      // pega o historico de mensagens
      socket.on('history', (msgHistoric) => {
        msgHistoric.forEach((msg) => {
          renderMessage(msg);
        });
      });

      socket.on('onlineUsers', (onlineUsers) => {
        onlineUsersList.innerHTML = '';
        onlineUsers.forEach((user) => {
          const li = document.createElement('li');
          li.setAttribute('data-testid', 'online-user');
          li.innerText = user.nick;
          onlineUsersList.appendChild(li);
        });
      });

      socket.on('disconnect', (users) => {
        console.log('MSG EMITIDA PELO BACK', users);
        onlineUsersList.innerHTML = '';
        renderMessage(`usuário saiu do chat...`);
      });
    </script>
  </body>
</html>
