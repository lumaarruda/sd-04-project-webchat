<!DOCTYPE html>
<html>
  <head>
    <script src="http://localhost:3000/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- CSS only -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1"
      crossorigin="anonymous"
    />
    <!-- JavaScript Bundle with Popper -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <main">
      <div>
        <h1>Chat Trybe</h1>
        <form  id="chat">
          <input
            type="text"
            id="nickname"
            placeholder="Digite seu nome"
            data-testid="nickname-box"
          /><button id="nickname-save" data-testid="nickname-save">
            Salvar usuário
          </button>
          <p id="userExist"></p>
          <div class="message-box"></div>
          <input
            type="text"
            id="chatMessage"
            data-testid="message-box"
            placeholder="Digite sua mensagem"
          /><button data-testid="send-button">Enviar</button>
        </form>
        <div >
          <h3 class="users">Usuários:</h3>
          <div>
            <ul id="online-user" data-testid="online-user"></ul>
          </div>
        </div>
        <hr>
        <br>
        <div>
          <form method="GET" action="/privatChat.html">
            <button data-testid="private" type="submit" >Chat privado</button>
          </form>
        </div>
      </div>
    </main>
    <script type="text/javascript">
      const socket = io('http://localhost:3000');

      function renderExist(message) {
        $('#userExist').append(message);
      }
      function renderMessage(message) {
        $('.message-box').append(
          '<div data-testid="message">' + message + '</div>'
        );
      }

      function renderUser(user) {
        console.log('user', user);

        $('#online-user').append(
          '<li data-testid="online-user"' +
            'id=' +
            user.userId +
            '>' +
            user.userName +
            '</li>'
        );
      }

      function renderAllUser(users) {
        // clearList();
        // const firstName = $('li:nth-child(1)').text();
        // console.log('firstName', firstName);
        users.forEach((item) => {
          $('#online-user').append(
            '<li data-testid="online-user"' +
              'id=' +
              item.userId +
              '>' +
              item.userName +
              '</li>'
          );
        });
      }

      function clearList() {
        $('ul li').remove();
      }

      // Atualiza o nome no do usuário
      // let nickname = $('input[id=nickname]').val();
      // const listUsers = [];
      // listUsers.push($('ul li').text());
      // if (jQuery.inArray('Tiago', listUsers) !== -1) {
      socket.on('userUpdate', function (data) {
        console.log('todos conectados', data);
        // console.log('dados', data.newName + data.id);
        $('#' + data.id).text(data.newName);
      });
      // }

      socket.on('disconected', function (data) {
        console.log('disconect', data);
        $('#' + data).remove();
      });

      // socket.emit('disconected');

      socket.on('userConected', function (user) {
        // console.log('conectado', users);
        renderUser(user);
      });

      socket.on('allUserConected', function (users) {
        console.log('conectados', users);
        renderAllUser(users);
      });

      socket.on('userExist', function (message) {
        renderExist(message);
      });

      socket.on('previousMessage', function (allMessages) {
        for (const iterator of allMessages) {
          renderMessage(
            `${iterator.dateTime} - ${iterator.nickname}: ${iterator.chatMessage}!`
          );
        }
      });

      socket.on('message', function (message) {
        renderMessage(message);
      });

      $('#chat').submit(function (event) {
        event.preventDefault();

        let nickname = $('input[id=nickname]').val();
        let chatMessage = $('input[id=chatMessage]').val();

        if (nickname.length && chatMessage.length) {
          //const messageObject = { nickname, chatMessage };
          // renderMessage(messageObject);
          socket.emit('message', { nickname, chatMessage });
        }
      });

      $(window).on('beforeunload', function () {
        socket.emit('disconected');
        console.log('closedddddd');
      });

      $('#nickname-save').click(function (event) {
        event.preventDefault();
        let userName = $('input[id=nickname]').val();
        // Altera o nome o usuário conectado
        // $('ul li').eq(0).html(userName);
        // Obtên o id do usuário
        let indice = $('ul li').attr('id');

        socket.emit('userConected', { userName, indice });
      });
    </script>
  </body>
</html>
