<!DOCTYPE html>
<html>

<head>
  <title>Socket.IO - trybe</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font: 13px Helvetica, Arial;
    }

    form#chatForm {
      background: #000;
      padding: 3px;
      position: fixed;
      bottom: 0;
      width: 100%;
    }

    form input {
      border: 0;
      padding: 10px;
      width: 90%;
      margin-right: 0.5%;
    }

    form button {
      width: 9%;
      background: rgb(130, 224, 255);
      border: none;
      padding: 10px;
      cursor: pointer;
    }

    form#nicknameForm {
      background: #000;
      padding: 3px;
      width: 100%;
    }

    #onlineUsers {
      padding: 3px;
      width: 100%;
    }

    #messagens {
      list-style-type: none;
      margin: 0;
      padding: 0;
    }

    #messagens li {
      padding: 5px 10px;
    }

    #messagens li:nth-child(odd) {
      background: #eee;
    }

  </style>
  <script src="http://localhost:3000/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script>
    $(() => {
      const socket = io('http://localhost:3000');
      const setMessage = (message, dataTestid) => $('#messagens').append($('<li>').text(message).attr('data-testid', dataTestid))
      $('document').ready(() => {
        socket.on('setHistory', (history) => {
          history.forEach((message) => {
            const formatedMessage = `${message.messageDate} ${message.nickname}: ${message.chatMessage}`
            console.log( formatedMessage );
            setMessage(formatedMessage, 'message');
          });
        });

      })
      socket.on('getName', (user) => {
        $('#nicknameForm').submit((e) => {
          e.preventDefault();
          if ($('#nicknameInput').val()) {
            $('#nicknameInput').val(user)
          }
          console.log(user);
        })
        
      })
      console.log($('#nicknameInput').val());
      socket.emit('setName', $('#nicknameInput').val())

      $('#chatForm').submit((e) => {
        e.preventDefault();
        if ($('#mensagemInput').val()) {
          socket.emit('mensagem', $('#mensagemInput').val());
          $('#mensagemInput').val('')
        }
      });
      socket.on('menssage', (message) => {
        setMessage(message, 'message')
      });
      socket.on('connectMessage', (message) => {
        setMessage(message, 'online-user');
      });
      socket.on('disconnectMessage', (message) => {
        setMessage(message, 'online-user');
      });
      socket.on('onlineUsers', async (users) => {
        await $('#userList').remove()
        $('#onlineUsers').append($('<ul>').attr('id', 'userList'))
        Object.values(users).map(value => $('#userList').append($('<li>').text(value)))

        console.log(Object.values(users));
      });
    });
  </script>
</head>

<body>
  <nav>
    <form id="nicknameForm">
      <input id=nicknameInput data-testid="nickname-box" type="text">
      <button type="submit" data-testid="nickname-save">Salvar</button>
    </form>
    <div>
      <ul id="onlineUsers"></ul>
    </div>
  </nav>
  <ul id="messagens"></ul>
  <form id="chatForm">
    <select name="chatSelect" id="chatSelect"></select>
    <input id="mensagemInput" data-testid="message-box" autocomplete="on" />
    <button type="submit" data-testid="send-button">Enviar</button>
  </form>
</body>

</html>
