<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Webchat</title>
    <script src="/socket.io/socket.io.js"></script>
  </head>
  <body>
    <h1>Webchat</h1>
    <div>
      <input type="text" id="input-nickname" data-testid="nickname-box" />
      <button type="button" id="submit-nickname" data-testid="nickname-save">
        Alterar Nickname
      </button>
    </div>
    <div>
      <form action="">
        <input type="text" id="input-message" data-testid="message-box" />
        <button type="submit" id="submit-message" data-testid="send-button">
          Enviar Mensagem
        </button>
      </form>
    </div>
    <ul id="list"></ul>
    <script>
      const socket = io();

      let nickname;

      const nicknameInput = document.getElementById('input-nickname');
      const btnSaveNickname = document.getElementById('submit-nickname');

      const messageInput = document.getElementById('input-message');
      const btnSendMessage = document.getElementById('submit-message');

      const messagesList = document.getElementById('list');

      btnSaveNickname.addEventListener(
        'click',
        () => (nickname = nicknameInput.value)
      );

      btnSendMessage.addEventListener('click', (e) => {
        e.preventDefault();
        // Emitir o evento 'message'
        socket.emit('message', {
          chatMessage: messageInput.value,
          nickname,
        });
        //
        messageInput.value = '';
      });

      socket.on('defaultNickname', (data) => {
        nickname = data;
      });

      socket.on('loadMessages', (data) => {
        if (data.length) {
          data.map((item) => {
            const li = document.createElement('li');
            li.textContent = `${item.date} - ${item.nickname}: ${item.chatMessage}`;
            li.setAttribute('data-testid', 'message');
            list.appendChild(li);
          });
        }
      });

      socket.on('serverResponse', (msg) => {
        const li = document.createElement('li');
        li.textContent = `${msg.date} - ${msg.nickname}: ${msg.chatMessage}`;
        li.setAttribute('data-testid', 'message');
        list.appendChild(li);
      });
    </script>
  </body>
</html>
