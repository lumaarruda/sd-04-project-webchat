<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Project WebChat - @cacobribeiro ~ Caio Ribeiro</title>
    <script src="http://localhost:3000/socket.io/socket.io.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
      integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <div class="d-flex justify-content-around">
      <div>
        <ul class="list-group" id="users-online">
          <li class="list-group-item">Cras justo odio</li>
        </ul>
        <div class="input-group mb-3">
          <input type="text" id="nickname" data-testid="nickname-box" class="form-control" />
          <div class="input-group-append">
            <button
              class="btn btn-primary input-group-text"
              data-testid="nickname-save"
              id="btn-nickname-save"
            >
              Send
            </button>
          </div>
        </div>
      </div>
      <div class="container-sm d-flex flex-column-reverse">
        <div class="input-group mb-3">
          <input type="text" id="input-msg" data-testid="message-box" class="form-control" />
          <div class="input-group-append">
            <button
              class="btn btn-primary input-group-text"
              data-testid="send-button"
              id="btn-send"
            >
              Send
            </button>
          </div>
        </div>
        <div>
          <ol id="message"></ol>
        </div>

        <h3 id="name"></h3>
      </div>
    </div>
  </body>
  <script>
    const addMsg = (pai, msg) => {
      console.log('msg', msg);
      const li = document.createElement('li');
      li.setAttribute('data-testid', 'message');
      li.classList = 'message';
      li.innerHTML = msg;
      return pai.appendChild(li);
    };

    window.onload = async () => {
      const message = document.querySelector('#message');
      const btnSend = document.querySelector('#btn-send');
      const btnNickname = document.querySelector('#btn-nickname-save');
      const name = document.querySelector('#name');

      const inputMsg = document.querySelector('#input-msg');
      const inputNickname = document.querySelector('#nickname');
      const usersOnline = document.querySelector('#users-online');

      const socket = io('http://localhost:3000');

      let nickname = 'Guest';
      socket.emit('logged', { nickname });

      socket.on('nickname', async (nickname) => {
        console.log();
        name.innerHTML = nickname;
      });

      socket.on('history', async (data) => {
        console.log(data);
        message.innerHTML = await data
          .map(
            (msg) =>
              `<li data-testid="message">${msg.timestamp} - ${msg.nickname}: ${msg.chatMessage}</li>`,
          )
          .join(' ');
      });

      socket.on('message', (msg) => {
        addMsg(message, msg);
      });

      socket.on('online-users', (users) => {
        users.forEach((user) => {
          const li = document.createElement('li');
          li.innerText = user.nickname;
          li.classList = 'list-group-item';
          li.setAttribute('data-testid', 'online-user');
          usersOnline.appendChild(li);
        });
      });

      btnSend.addEventListener('click', (event) => {
        event.preventDefault();
        const date = new Date().toLocaleString();
        const chatMessage = inputMsg.value;
        socket.emit('message', { chatMessage, nickname });
        inputMsg.value = '';
      });

      btnNickname.addEventListener('click', (event) => {
        event.preventDefault();
        nickname = inputNickname.value;
        socket.emit('nickname', nickname);
      });
    };
  </script>
</html>
