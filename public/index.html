<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Web chat</title>
    <script src="http://localhost:3000/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  </head>
  <body>
    <form>
      <input
        data-testid="nickname-box"
        id="nickname"
        type="text"
        placeholder="nickname"
      />
      <button data-testid="nickname-save" id="nickBtn" type="button">
        select
      </button>
      <span id="chosenNick"></span>
      <div>
        <ul id="onlineUser"></ul>
      </div>
      <br />
      <input
        data-testid="message-box"
        id="messageBox"
        type="text"
        placeholder="type your message"
      />
      <button data-testid="send-button" id="msgBtn" type="button">send</button>
      <div>
        <ul id="messagesList" style="list-style: none"></ul>
      </div>
      <div>
        <button data-testid="public" type="button" id="public">Public Chat</button>
        <ul id="privateMessages"></ul>
      </div>
    </form>
    <script>
      const socket = io('http://localhost:3000');

      const nickName = document.querySelector('#nickname');
      const nickBtn = document.querySelector('#nickBtn');
      const chosenNick = document.querySelector('#chosenNick');
      const messageBox = document.querySelector('#messageBox');
      const msgBtn = document.querySelector('#msgBtn');
      const msgList = document.querySelector('#messagesList');
      const privateMsgList = document.querySelector('#privateMessages');
      let privateMessage = false;
      let privateReceiver = '';

      function renderUsers(data) {
        let element;
        let privateChat;
        let publicChat;
        for (user of data) {
          privateChat = document.createElement('button');
          privateChat.setAttribute('type', 'button');
          privateChat.setAttribute('data-testid', 'private');
          privateChat.setAttribute('onClick', 'privateAction(this.innerText)');
          privateChat.innerText = user;
          if (privateChat.innerText === chosenNick.innerText) {
          privateChat.setAttribute('disabled', 'disabled');
        }

          element = document.createElement('li');
          element.setAttribute('data-testid', 'online-user');
          element.setAttribute('class', 'online');
          // element.innerText = user;
          element.appendChild(privateChat);
          document.querySelector('#onlineUser').appendChild(element);
        }
        const privateChatBtn = document.querySelector('#private');
        const publicChatBtn = document.querySelector('#public');

        publicChatBtn.addEventListener('click', () => {
          privateMessage = false;
        });
      }

      function privateAction (clickedUser) {
          privateMessage = true;
          privateReceiver = clickedUser;
        };

      socket.on('updateUsers', (data) => {
        const users = Object.values(data);
        let list = document.querySelectorAll('.online');
        for (let i = 0; i < list.length; i++) {
          list[i].remove();
        }
        renderUsers(users);
      });

      socket.on('history', (data) => {
        const reversedData = Object.values(data).reverse();
        const date = moment(reversedData.timestamp).format(
          'DD-MM-yyyy h:mm:ss A'
        );
        let li = '';
        if (document.querySelectorAll('li')) {
          li = document.querySelectorAll('li');
          for (list of li) {
            list.remove();
          }
        }
        for (dt of reversedData) {
          li = document.createElement('li');
          li.setAttribute('data-testid', 'message');
          li.innerText = `${date} - ${dt.nickname}: ${dt.chatMessage}`;
          msgList.appendChild(li);
        }
      });

      socket.on('newUser', (data) => {
        chosenNick.innerText = data;
      });

      nickBtn.addEventListener('click', () => {
        chosenNick.innerHTML = nickName.value;
        socket.emit('chosenNick', nickName.value);
      });

      msgBtn.addEventListener('click', () => {
        if (privateMessage === false) {
          const chatMessage = messageBox.value;
          const nickname = chosenNick.innerText;
          socket.emit('message', { chatMessage, nickname });
          messageBox.value = '';
        } else {
          const chatMessage = messageBox.value;
          const nickname = chosenNick.innerText;
          socket.emit('privateMessage', { chatMessage, nickname, privateReceiver });
          messageBox.value = '';
        }
      });

      socket.on('message', (data) => {
        const li = document.createElement('li');
        li.setAttribute('data-testid', 'message');
        li.innerText = data;
        msgList.appendChild(li);
      });

      socket.on('new privateMessageSender', (data) => {
        const li = document.createElement('li');
        li.setAttribute('data-testid', 'message');
        li.innerText = data;
        privateMsgList.appendChild(li);
      });

      socket.on('new privateMessage', (data) => {
        const li = document.createElement('li');
        li.setAttribute('data-testid', 'message');
        li.innerText = data;
        privateMsgList.appendChild(li);
      });
    </script>
  </body>
</html>
