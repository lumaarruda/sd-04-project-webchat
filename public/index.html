<!DOCTYPE html>
<html>

<head>
  <title>Socket.IO - trybe</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font: 13px Helvetica, Arial;
    }

    form#chatForm {
      background: #000;
      padding: 3px;
      position: fixed;
      bottom: 0;
      width: 100%;
    }

    form input {
      border: 0;
      padding: 10px;
      width: 90%;
      margin-right: 0.5%;
    }

    form button {
      width: 9%;
      background: rgb(130, 224, 255);
      border: none;
      padding: 10px;
      cursor: pointer;
    }

    form#nicknameForm {
      background: #000;
      padding: 3px;
      width: 100%;
    }

    #onlineUsers {
      padding: 3px;
      width: 100%;
    }

    #messagens {
      list-style-type: none;
      margin-top: 10px;
      padding: 0;
    }

    #messagens li {
      padding: 5px 10px;
    }

    #messagens li:nth-child(odd) {
      background: #eee;
    }

  </style>
  <script src="http://localhost:3000/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script>
    $(() => {
      const socket = io('http://localhost:3000');
      let standartNicknameValue;

      const setMessage = (message) => $('#messagens').append($('<li>').text(message).attr('data-testid', 'message'));
      const localHistory = {
        'public': [],
        'private': [],
      }
      let nickname;
      let receiver;
      let chatType = 'public';

      const updateUserList = async (users, type) => {
        $('#userList').remove();
        $('#chatType').remove();

        $('#onlineUsers').append($('<ul>').attr('id', 'userList'));
        if (Object.values(users).length > 1) {
          $('nav').append($('<select>').attr('id', 'chatType'));
          $('#chatType').append($('<option>').text('').val(''))
          if (type !== 'private') {
            $('#chatType').attr('disabled', true)
            $('#public').attr('class', 'choosed')
          }
        }
        Object.keys(users).forEach((userId) => {
          console.log(userId);
          if (userId !== socket.id) {
            $('#chatType').append($('<option>').text(users[userId]).val(userId))
          }
          $('#userList').append($('<li>').text(users[userId]));
        })
      }

      try {
        socket.on('connect', () => {
          if (!$('#nicknameInput').val()) {
            standartNicknameValue = `Guest_${socket.id}`;
            $('#nicknameInput').val(standartNicknameValue);
            socket.emit('setNickname', standartNicknameValue);
          }
          socket.emit('history', 'public')
        });

        socket.on('history', (history, type, users) => {
          if (type === 'public') {
            localHistory['public'] = history
          }
          localHistory[type].forEach(({ nickname, message, timestamp }) => {
            const formatedMessage = `${timestamp} ${type == 'private' ? '(private)' : ''} - ${nickname}: ${message}`;
            localHistory[type].push(formatedMessage);
            setMessage(formatedMessage);
          });
          updateUserList(users, type);
        });



        $('#nicknameForm').submit((e) => {
          e.preventDefault();
          const nicknameValue = $('#nicknameInput').val();
          if (nicknameValue && nicknameValue != standartNicknameValue) {
            console.log(nicknameValue);
            socket.emit('setNickname', nicknameValue);
          }
        });

        $('#chatForm').submit((e) => {
          e.preventDefault();
          const messageValue = $('#mensagemInput').val();
          const nicknameValue = $('#nicknameInput').val();
          const type = $('#type').val();
          const receiver = $('#chatType').val();
          console.log(receiver);
          if (messageValue && socket.id !== receiver) {
            socket.emit('message', { nicknameValue, messageValue, receiver }, type);
            $('#mensagemInput').val('');
          }
        });
        socket.on('message', (message) => {
          console.log(message);
          setMessage(message);
        });

        $('#public').click(() => {
          $('#chatType').attr('disabled', true)
          $('#public').attr('class', 'choosed')
          $('#private').removeAttr('class')
          $('#messagens').empty()
          socket.emit('history', 'public')
        })

        $('#private').click(() => {
          $('#chatType').removeAttr('disabled')
          $('#private').attr('class', 'choosed')
          $('#public').removeAttr('class')
          $('#messagens').empty()
          socket.emit('history', 'private')
        })

        socket.on('setUsers', (users) => {
          updateUserList(users)
        });

      } catch (error) {
        socket.emit('error', error);
      };
    });
  </script>
</head>

<body>
  <nav>
    <form id="nicknameForm">
      <input id=nicknameInput data-testid="nickname-box" type="text">
      <button data-testid="nickname-save">Salvar</button>
    </form>
    <div>
      <ul id="onlineUsers"></ul>
    </div>
    <button data-testid="public" id="public" value="public">PÃºblico</button>
    <button data-testid="private" id="private" value="private">Privado</button>
  </nav>
  <ul id="messagens"></ul>
  <form id="chatForm">
    <input id="mensagemInput" data-testid="message-box" autocomplete="on" />
    <button data-testid="send-button">Enviar</button>
  </form>
</body>

</html>
